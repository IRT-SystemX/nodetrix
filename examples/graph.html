<!DOCTYPE html>
<html lang="en">
	<head>
		<title></title>
		<style type="text/css">
		body { font-family: "Calibri"; font-size: 12px; }
		.background { stroke: transparent; stroke-width: 1px; fill: white; }
		.brush { fill: transparent; stroke: gray; strokeWidth: 1px; }
		.node-label rect { fill: white; } .node-label text { font-size: 9px; } .node { opacity: 0.3; }
		</style>
	</head>
	<body>
		<div id="graph" style="width: 500px; height: 500px; border: 1px gray solid; float: left;"></div>
		<div id="colorscale" style="width: 200px; height: 302px; float: left;"></div>

		<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js" charset="utf-8"></script>
		<script src="http://threejs.org/examples/js/libs/stats.min.js"></script>

		<script type="text/javascript" src="/lib/d3.min.js"></script>

		<script type="text/javascript" src="/src/context.js"></script>
		<script type="text/javascript" src="/src/widgets/graph.js"></script>
		<script type="text/javascript" src="/src/widgets/colorscale.js"></script>
		<script type="text/javascript" src="/src/interactions/zoom.js"></script>

		<script type="text/javascript">
		var renderer =  "gl"; //"gl";

		// interactions / visual encoding
		var bindInteractions = function(data) {
			var keyDown = false; var panNzoom = new nodetrix[renderer].interaction.Zoom($.context.widgets.graph);
			d3.select("body").on("keydown", function() { if (d3.event.altKey) { if (!keyDown) { keyDown = true; panNzoom.bind(); } } });
			d3.select("body").on("keyup", function() { if (keyDown) { keyDown = false; panNzoom.unbind(); } });

			$.context.widgets.graph.nodeHandler.mouseover = function(event, widget, d) { if (widget.config.allowHighlight) $.context.widgets.graph.highlight($.context.highlighted.concat([d.raw])); };
			$.context.widgets.graph.nodeHandler.mouseout = function(event, widget, d) { if (widget.config.allowHighlight) $.context.widgets.graph.highlight($.context.highlighted); };

			var selectedGroup = $.context.widgets.colorscale.selectedGroup;
			$.context.widgets.colorscale.groupHandler.click = function(event, widget, d) { if (widget.config.allowHighlight) d.items.forEach(function(node) { $.context.highlight(node); }); };
			$.context.widgets.colorscale.groupHandler.mouseover = function(event, widget, d) { if ($.inArray(d, selectedGroup) < 0) { d.isHighlighted = true; widget.render(); } };
			$.context.widgets.colorscale.groupHandler.mouseout = function(event, widget, d) { if ($.inArray(d, selectedGroup) < 0) { d.isHighlighted = false; widget.render(); } };
		};

		// data loading
		var load = function(data) {
			var labels = []; data.nodes.forEach(function(d) { labels.push(d.name); });
			$.context.widgets.graph.bind(data, labels);
			$.context.setLoaded();
		};

		// extract labels from data
		var index = function(items, getGroup) {
			var index = {}, reversed =  {};
			items.forEach(function(d, i) { var label = getGroup(d, i); if (!(label in index)) index[label] = []; index[label].push(d); reversed[d.name] = label; });
			return { index: index, reversed: reversed };
		};

		// Clustering selector
		$.currentClustering = "labels";
		var updateClustering = function() {
			$.context.widgets.colorscale.bind($.context.clustering[$.currentClustering].index);
			$.context.widgets.graph.graph.nodes.forEach(function(d) { d.label = $.context.clustering[$.currentClustering].reversed[d.raw.name]; });
			$.context.widgets.graph.nodeColor = function(d) { return d.label !== undefined ? $.context.widgets.colorscale.coloring( d.label ) : $.context.widgets.nodetrix.config.nodeColor; };
			$.context.widgets.graph.render();
		};

		$.context = new nodetrix.Context(function() { d3.json("/data/miserables.json", function (data) { console.log(data); load(data); }); });
		$.context.waitLoaded(function() {

			// Compute a graph clustering
			var nodes = []; $.context.widgets.graph.graph.nodes.forEach(function(node) { nodes.push('raw' in node ? node.raw : node); });
			var links = []; $.context.widgets.graph.graph.links.forEach(function(link) { links.push('raw' in link ? link.raw : link); });

			$.context.clustering = {};
			$.context.clustering.labels = index(nodes, function(d) { return d.group; });
			$.context.clustering.none = { index: {}, reversed: {} };

			$.context.widgets.graph.clustering = $.context.clustering.labels.index;
			$.context.widgets.graph.graph.nodes.forEach(function(d) { d.label = -1; d.labels = false; });

			updateClustering();
			bindInteractions();

			if (renderer == "gl") {
				stats = new Stats(); stats.domElement.style.position = 'absolute'; stats.domElement.style.top = '0px'; document.body.appendChild(stats.domElement);
				var animate = $.context.widgets.graph.animate;
				$.context.widgets.graph.animate = function() {
					animate.call(this);
					stats.update();
				};
			}
		});

		// Bind d3 widget to div elements
		$.context.createWidget("graph", nodetrix[renderer].Graph, $("#graph").width(), $("#graph").height(), { nodecolor: "lightGray", nodestroke: "gray", linkstroke: "lightGray", allowlayout: true, allowlabels: true, nodesize: 10, cellsize: 12, round: 100, nodestrokewidth: 1 });
		$.context.createWidget("colorscale", nodetrix.d3.Legend, $("#colorscale").width(), $("#colorscale").height(), { hue: 220 });
		</script>

	</body>
</html>
